// âœ… Import necessary functions from RTK Query
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'
import type { RootState } from '@/app/store' // ğŸ“¦ Import our RootState type for accessing auth slice

// âœ… Create RTK Query API Slice for Authentication
export const authApi = createApi({
    reducerPath: 'authApi', // ğŸ”‘ Unique key in Redux store

    // ğŸ”Œ Base configuration for all API requests
    baseQuery: fetchBaseQuery({
        baseUrl: import.meta.env.VITE_API_BASE_URL, // ğŸŒ Base URL from `.env` file (e.g., http://localhost:3000/api)

        // ğŸ” Automatically attach Authorization header with token from Redux store
        prepareHeaders: (headers, { getState }) => {
            const token = (getState() as RootState).auth.token // ğŸ§  Get token from auth slice
            if (token) {
                headers.set('Authorization', `Bearer ${token}`) // ğŸ“ Set Authorization header
            }
            return headers
        },
    }),

    // ğŸ“¡ Define API endpoints
    endpoints: (builder) => ({
        // ğŸ”“ Login endpoint
        login: builder.mutation<
            { token: string },                    // âœ… Expected response type from backend
            { email: string; password: string }  // ğŸ“¤ Data we send in request
        >({
            query: (credentials) => ({
                url: '/auth/login',
                method: 'POST',
                body: credentials, // ğŸ§¾ POST body = email + password
            }),
        }),

        // ğŸ“ Register endpoint
        register: builder.mutation<
            { token: string },                    // âœ… Expected response (JWT token)
            any                                   // ğŸ”„ Input body â€” could be typed more strictly
        >({
            query: (body) => ({
                url: '/auth/register',
                method: 'POST',
                body, // ğŸ‘¤ includes name, profession, email, password
            }),
        }),

        // ğŸ‘¤ Get current authenticated user
        getMe: builder.query<
            { id: string; email: string; name: string; role: string }, // âœ… Response = user info
            void                                         // ğŸš« No input params
        >({
            query: () => '/auth/me', // ğŸ” GET request to /auth/me
        }),
    }),
})

// âœ… Export hooks auto-generated by RTK Query
export const {
    useLoginMutation,
    useRegisterMutation,
    useGetMeQuery,
    useLazyGetMeQuery,
} = authApi
